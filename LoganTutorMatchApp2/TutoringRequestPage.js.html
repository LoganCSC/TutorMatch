<script>

  var dataMap;  // the map from subjects to courses to tutors

  /**
   * Run initializations on page load.
   */
  $(function() {
    initialize();
  });

  function initialize() {
    loadDataMap();

    // initially hide later selects until earlier ones are set
    $('#subjectSelect select').bind('change', populateCourseSelect);
    $('#courseSelect select').bind('change', populateTutorSelect);
    $('#courseSelect').hide();
    $('#tutorSelect').hide();
  }

  /**
   * Retrieve the dataMap from the server and populate the subject select when done.
   */
  function loadDataMap() {
    google.script.run.withSuccessHandler(populateSubjectSelect)
        .withFailureHandler(showError)
        .getDataMap();
  }

  /**
   * Show the returned list of subjects in the dropdown.
   * @param {Array.<Object>} db the dataMap. The keys are subjects.
   */
  function populateSubjectSelect(dm) {
    dataMap = dm;
    var select = $('#subjectSelect select');
    populateSelect(select, dataMap);
  }

  function populateCourseSelect() {
  $('#courseSelect').show();
    var select = $('#courseSelect select');
    populateSelect(select, dataMap[getSelectedSubject()]);
  }

  function populateTutorSelect() {
    $('#tutorSelect').show();
    var select = $('#tutorSelect select');
    populateSelect(select, dataMap[getSelectedSubject()][getSelectedCourse()]);
  }

  function getSelectedSubject() {
    return $('#subjectSelect select').val();
  }

  function getSelectedCourse() {
    return $('#courseSelect select').val();
  }

  /**
   * @param select the droplist to populate with items.
   * @param map objects whose keys contains the items. There will always be an initial "not selected" value.
   */
  function populateSelect(select, map) {
    select.empty();
    select.append(getNotSelectedOption());
    for (var subject in map) {
      var option = $('<option>')
          .attr('value', subject)
          .text(subject);
      select.append(option);
    };
  }

  function getNotSelectedOption() {
    return $('<option>')
          .attr('value', "NOT-SELECTED")
          .text("--- Select ---");
  }

  /**
   * Logs an error message and shows an alert to the user.
   */
  function showError(error) {
    console.log(error);
    window.alert('An error has occurred, please try again.');
  }
</script>
