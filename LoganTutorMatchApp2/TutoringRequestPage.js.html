<script>

  var NOT_SELECTED = "NOT-SELECTED";
  var dataMap;  // the map from subjects to courses to tutors

  /**
   * Run initializations on page load.
   */
  $(function() {
    initialize();
  });

  function initialize() {
    loadDataMap();

    // initially hide later selects until earlier ones are set
    $('#subjectSelect select').bind('change', subjectChangedHandler);
    $('#courseSelect select').bind('change', courseChangedHandler);
    $('#tutorSelect select').bind('change', showTutorDetails);
    $('#courseSelect').hide();
    $('#tutorSelect').hide();
    $('#tutorDetails').hide();
  }

  /**
   * Retrieve the dataMap from the server and populate the subject select when done.
   */
  function loadDataMap() {
    google.script.run.withSuccessHandler(populateSubjectSelect)
        .withFailureHandler(showError)
        .getDataMap();
  }

  function subjectChangedHandler() {
    var subject = selectedSubject();
    $('#tutorDetails').hide();
    $('#tutorSelect').hide();
    if (subject == NOT_SELECTED) {
      $('#courseSelect').hide();
    } else {
      populateCourseSelect();
    }
  }

  function courseChangedHandler() {
    var course = selectedCourse();
    $('#tutorDetails').hide();
    if (course == NOT_SELECTED) {
      $('#tutorSelect').hide();
    } else {
      populateTutorSelect();
    }
  }

  /**
   * Show the returned list of subjects in the dropdown.
   * @param {Array.<Object>} db the dataMap. The keys are subjects.
   */
  function populateSubjectSelect(dm) {
    dataMap = dm;
    var select = $('#subjectSelect select');
    populateSelect(select, dataMap);
  }

  function populateCourseSelect() {
  $('#courseSelect').show();
    var select = $('#courseSelect select');
    populateSelect(select, dataMap[selectedSubject()]);
  }

  function populateTutorSelect() {
    $('#tutorSelect').show();
    var select = $('#tutorSelect select');
    populateSelect(select, dataMap[selectedSubject()][selectedCourse()]);
  }

  /**
   * @param select the droplist to populate with items.
   * @param map objects whose keys contains the items. There will always be an initial "not selected" value.
   */
  function populateSelect(select, map) {
    select.empty();
    select.append(getNotSelectedOption());
    for (var subject in map) {
      var option = $('<option>')
          .attr('value', subject)
          .text(subject);
      select.append(option);
    };
  }

  function getNotSelectedOption() {
    return $('<option>')
          .attr('value', NOT_SELECTED)
          .text("--- Select ---");
  }

  /**
   * Populate table with selected tutor details
   */
  function showTutorDetails() {
      var tutorInfo = dataMap[selectedSubject()][selectedCourse()][selectedTutor()];
      //alert("tutorInfo = " + JSON.stringify(tutorInfo));

      $('#tutorDetails').show();
      var table = $("#tutorDetails table")
      table.empty();
      addRow(table, "Name", tutorInfo.name);
      addRow(table, "Gender", tutorInfo.gender);
      addRow(table, "Email", tutorInfo.email);
      addRow(table, "Availability", tutorInfo.whenAvailable);
      addRow(table, "Alternative languages", tutorInfo.foreignLanguages);
      addRow(table, "Graduation year", tutorInfo.graduationYear);
  }

  function addRow(table, label, value) {
    table.append('<tr><td>' + label + '</td><td>' + value + '</td></tr>');
  }

  function selectedSubject() {
    return $('#subjectSelect select').val();
  }

  function selectedCourse() {
    return $('#courseSelect select').val();
  }

  function selectedTutor() {
    return $('#tutorSelect select').val();
  }

  /**
   * Logs an error message and shows an alert to the user.
   */
  function showError(error) {
    console.log(error);
    window.alert('An error has occurred, please try again.');
  }
</script>
